<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mana Bazar | Seller Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 50px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    header h1 {
      font-size: 1.8em;
      color: #00c9ff;
      letter-spacing: 1px;
    }

    .sell-btn {
      padding: 12px 20px;
      background: #00c9ff;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
    }
    .sell-btn:hover { background: #007bff; transform: scale(1.05); }

    .dashboard {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .stat-card {
      flex: 1;
      min-width: 180px;
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }
    .stat-card h3 { color: #00eaff; font-size: 1.8em; }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 25px;
    }

    .product-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 15px;
      transition: 0.3s;
      position: relative;
    }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .product-card img { width: 100%; height: 180px; object-fit: cover; border-radius: 12px; }

    .status {
      position: absolute; top: 10px; right: 10px;
      background: #00c9ff; color: #fff;
      padding: 5px 10px; border-radius: 8px;
      font-size: 0.8em;
    }

    .delete-btn {
      background: #ff4d4d;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
    }
    .delete-btn:hover { background: #e60000; }

    /* Upload Form Modal */
    #uploadModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .form-container {
      background: #fff; color: #333;
      padding: 30px;
      border-radius: 16px;
      width: 90%; max-width: 600px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
      animation: slideIn 0.4s ease;
    }

    @keyframes slideIn {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    label { display: block; margin-top: 10px; font-weight: 600; }
    input, textarea, select {
      width: 100%; padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .close-btn {
      position: absolute; top: 20px; right: 30px;
      font-size: 22px; cursor: pointer; color: #fff;
    }

    button {
      margin-top: 15px; padding: 12px;
      border: none; border-radius: 8px;
      background: #00c9ff;
      color: #fff; font-weight: bold; cursor: pointer;
    }
    button:hover { background: #007bff; }
  </style>
</head>
<body>
  <header>
    <h1>üõí Mana Bazar ‚Äî Seller Dashboard</h1>
    <button class="sell-btn" onclick="openUploadForm()">+ Sell Product</button>
  </header>

  <div class="dashboard">
    <div class="stats">
      <div class="stat-card"><h3 id="totalProducts">0</h3><p>Total Products</p></div>
      <div class="stat-card"><h3 id="soldProducts">0</h3><p>Products Sold</p></div>
      <div class="stat-card"><h3 id="totalEarnings">‚Çπ<span id="seller_earnings">0</span></h3><p>Total Earnings</p></div>
    </div>

    <h2>Your Uploaded Products</h2>
    <div id="productGrid" class="product-grid">
      <p>Loading your products...</p>
    </div>
  </div>

  <!-- Upload Product Modal -->
  <div id="uploadModal">
    <span class="close-btn" onclick="closeUploadForm()">‚úñ</span>
    <div class="form-container">
      <h2>Upload a New Product</h2>
      <form id="productForm">
        <label>Product Name</label>
        <input type="text" id="name" required>
        <label>Price (‚Çπ)</label>
        <input type="number" id="price" required>
        <label>Category</label>
        <select id="category" required>
          <option value="">Select Category</option>
          <option value="Clothing">Clothing</option>
          <option value="Electronics">Electronics</option>
          <option value="Home">Home</option>
          <option value="Accessories">Accessories</option>
        </select>
        <label>Brand</label>
        <input type="text" id="brand" required>
        <label>Warranty (in months)</label>
        <input type="number" id="warranty" required>
        <label>Description</label>
        <textarea id="description" rows="3" required></textarea>
        <label>Upload Images</label>
        <input type="file" id="images" accept="image/*" multiple required>
        <button type="submit">Upload Product</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://gpyuveeyrckpwokdgzba.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdweXV2ZWV5cmNrcHdva2RnemJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDEzNTIsImV4cCI6MjA3NTQ3NzM1Mn0.mhv2u5uhzqKhgWQqNPysR3Haa5DwL1LtLfeyOvLGPLo';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const CLOUD_NAME = "dyhdhwbdz";
    const UPLOAD_PRESET = "unsigned_preset";

    const productGrid = document.getElementById("productGrid");
    const modal = document.getElementById("uploadModal");

    function openUploadForm() { modal.style.display = "flex"; }
    function closeUploadForm() { modal.style.display = "none"; }
    window.openUploadForm = openUploadForm;
    window.closeUploadForm = closeUploadForm;

    // Load seller stats and products
    async function loadSellerDashboard() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { alert("Please login first!"); window.location.href = "index.html"; return; }

      // ---------- Stats ----------
      const { count: total } = await supabase.from("products").select("*", { count: "exact" }).eq("seller_id", user.id);
      const { count: sold } = await supabase.from("products").select("*", { count: "exact" }).eq("seller_id", user.id).eq("status", "booked");
      const { data: earningsData } = await supabase.from("products").select("price").eq("seller_id", user.id).eq("status", "booked");
      const totalEarnings = earningsData?.reduce((sum, p) => sum + (parseFloat(p.price) || 0), 0) || 0;
      document.getElementById("totalProducts").textContent = total || 0;
      document.getElementById("soldProducts").textContent = sold || 0;
      document.getElementById("totalEarnings").textContent = "‚Çπ" + totalEarnings.toLocaleString();

      // ---------- Products ----------
      const { data: products, error } = await supabase.from("products").select("*").eq("seller_id", user.id).order("created_at", { ascending: false });
      if (error) { console.error("Error loading products:", error); productGrid.innerHTML = "<p>Failed to load your products.</p>"; return; }
      if (!products.length) { productGrid.innerHTML = "<p>No products uploaded yet.</p>"; return; }

      productGrid.innerHTML = "";
      for (let p of products) {
        const card = document.createElement("div");
        card.className = "product-card";
        const statusColor = p.status === "booked" ? "#ff9800" : p.status === "cart" ? "#ffc107" : "#00c9ff";
        card.innerHTML = `
          <span class="status" style="background:${statusColor};">${p.status || "available"}</span>
          <img src="${p.image || 'placeholder.jpg'}" alt="${p.name}">
          <h3>${p.name}</h3>
          <p>‚Çπ${p.price}</p>
          <p>${p.category}</p>
          <p><small>${p.description}</small></p>
          <button class="delete-btn" onclick="deleteProduct('${p.id}')">üóëÔ∏è Delete</button>
          <div id="feedback-${p.id}" style="margin-top:10px;font-size:0.9em;color:#fff;"></div>
        `;
        productGrid.appendChild(card);

        // Load feedback for each product
        const { data: feedbacks } = await supabase.from("feedback").select("rating, comment").eq("product_id", p.id);
        const feedbackHTML = feedbacks?.length
          ? feedbacks.map(f => `<p>‚≠ê ${f.rating}/5 ‚Äî ${f.comment}</p>`).join("")
          : "<p>No feedback yet.</p>";
        document.getElementById(`feedback-${p.id}`).innerHTML = feedbackHTML;
      }
    }

    loadSellerDashboard();

    // Handle product upload
    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { alert("Login required!"); return; }

      const name = document.getElementById("name").value;
      const price = document.getElementById("price").value;
      const category = document.getElementById("category").value;
      const brand = document.getElementById("brand").value;
      const warranty = document.getElementById("warranty").value;
      const description = document.getElementById("description").value;
      const files = document.getElementById("images").files;

      const imageUrls = [];
      for (let file of files) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: formData });
        const data = await res.json();
        if (data.secure_url) imageUrls.push(data.secure_url);
      }

      const { error } = await supabase.from("products").insert([{
        seller_id: user.id,
        name, price, category, brand, warranty, description,
        image: imageUrls[0],
        images: imageUrls,
        status: "available",
        created_at: new Date().toISOString()
      }]);

      if (error) alert("‚ùå Failed to upload product: " + error.message);
      else {
        alert("‚úÖ Product uploaded successfully!");
        closeUploadForm();
        loadSellerDashboard();
      }
    });
      async function loadSellerEarnings() {
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return;
          const { data, error } = await supabase
            .from('users')
            .select('earnings')
            .eq('id', user.id)
            .single();
          if (!error && data) document.getElementById("seller_earnings").textContent = data.earnings || 0;
        }
        loadSellerEarnings();

    // Delete product
    window.deleteProduct = async function(id) {
      if (confirm("üóëÔ∏è Delete this product?")) {
        const { error } = await supabase.from("products").delete().eq("id", id);
        if (error) alert("‚ùå Failed to delete: " + error.message);
        else {
          alert("‚úÖ Product deleted!");
          loadSellerDashboard();
        }
      }
    };
  </script>
</body>
</html>
